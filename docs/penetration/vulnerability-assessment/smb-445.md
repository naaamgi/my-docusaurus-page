---
sidebar_position: 4
title: SMB (Port 445)
---

# SMB 취약점 진단 (포트 445)

## 개요

**SMB (Server Message Block)**: 파일 및 프린터 공유 프로토콜

**주요 용도**:
- 파일 및 디렉토리 공유
- 프린터 공유
- 원격 명령 실행
- Windows 인증

**포트**:
- 445/TCP: SMB over TCP
- 139/TCP: SMB over NetBIOS (레거시)

---

## 취약점 진단 체크리스트

### 1. Null Session (익명 접속)
계정 정보 없이 접근 가능 여부

### 2. 공유 폴더 권한
- 읽기 권한: 정보 유출
- 쓰기 권한: 악성 파일 업로드

### 3. 접근 가능한 Share
공개된 또는 잘못 설정된 공유 폴더

### 4. 알려진 취약점
- MS08-067: Netapi 원격 코드 실행
- MS17-010: EternalBlue (WannaCry에 사용됨)
- SMBGhost (CVE-2020-0796)
- MS15-011: Group Policy

### 5. SMB 버전 및 서명
- SMBv1: 보안 취약, 비활성화 권장
- SMB Signing: 비활성화 시 중간자 공격 가능

---

## 정보 수집

### Nmap 기본 스캔

```bash
# 서비스 버전 및 기본 정보
nmap -p 445 -sV -sC <target>

# SMB 정보 수집 스크립트
nmap -p 445 --script smb-os-discovery <target>

# 예시
nmap -p 445 -sV -sC 192.168.1.10

# 출력 예시:
# 445/tcp open  microsoft-ds  Samba smbd 4.13.17-Ubuntu
# | smb2-time:
# |   date: 2024-01-15T10:30:00
# | smb2-security-mode:
# |   3:1:1:
# |     Message signing enabled but not required
```

### Enum4linux (레거시 도구)

```bash
# 전체 열거
enum4linux -a <target>

# 예시
enum4linux -a 192.168.1.10
```

**수집 정보**:
- OS 정보
- 도메인 정보
- 사용자 목록
- Share 목록
- 그룹 정보
- 패스워드 정책

### NetExec (CrackMapExec 후속, 권장)

```bash
# 설치
pipx install git+https://github.com/Pennyw0rth/NetExec.git

# 기본 정보 수집
nxc smb <target>

# Null Session 테스트
nxc smb <target> -u '' -p ''

# 익명 접속으로 Share 열거
nxc smb <target> -u '' -p '' --shares

# 사용자 인증 정보로 접속
nxc smb <target> -u <username> -p <password>

# 예시
nxc smb 192.168.1.10 -u '' -p ''
```

### Smbmap

```bash
# Share 목록 및 권한 확인
smbmap -H <target>

# Null Session
smbmap -H <target> -u '' -p ''

# 특정 Share 내용 확인
smbmap -H <target> -u '' -p '' -r <share_name>

# 재귀적으로 모든 파일 목록
smbmap -H <target> -u '' -p '' -R

# 예시
smbmap -H 192.168.1.10 -u '' -p ''

# 출력 예시:
# [+] IP: 192.168.1.10:445    Name: target.local
#         Disk            Permissions     Comment
#         ----            -----------     -------
#         print$          NO ACCESS       Printer Drivers
#         Public          READ, WRITE
#         IPC$            NO ACCESS       IPC Service
```

---

## SMB 접속 및 탐색

### Smbclient

```bash
# Share 목록 확인
smbclient -L //<target> -N

# Null Session 접속
smbclient //<target>/<share_name> -N

# 인증 정보로 접속
smbclient //<target>/<share_name> -U <username>

# 예시
smbclient //192.168.1.10/Public -N
```

**SMB 쉘 명령어**:
```bash
ls                  # 파일 목록
cd <directory>      # 디렉토리 이동
pwd                 # 현재 경로
get <file>          # 파일 다운로드
mget *              # 모든 파일 다운로드
put <file>          # 파일 업로드
mput *              # 모든 파일 업로드
help                # 도움말
```

### Mount (Linux)

```bash
# SMB Share 마운트
sudo mkdir /mnt/smb
sudo mount -t cifs //<target>/<share> /mnt/smb -o username=<user>,password=<pass>

# Null Session 마운트
sudo mount -t cifs //<target>/<share> /mnt/smb -o guest

# 예시
sudo mount -t cifs //192.168.1.10/Public /mnt/smb -o guest

# 마운트 해제
sudo umount /mnt/smb
```

---

## 취약점 스캔

### Nmap SMB 취약점 스크립트

```bash
# 모든 SMB 취약점 스캔
nmap -p 445 --script "smb-vuln-*" <target>

# 특정 취약점 확인
nmap -p 445 --script smb-vuln-ms17-010 <target>

# 예시
nmap -p 445 --script "smb-vuln-*" 192.168.1.10
```

**주요 취약점 스크립트**:
- `smb-vuln-ms17-010`: EternalBlue
- `smb-vuln-ms08-067`: Netapi
- `smb-vuln-cve2009-3103`: SMBv2 Negotiate Protocol
- `smb-vuln-cve-2017-7494`: SambaCry

### Metasploit

```bash
msfconsole

# SMB 버전 스캔
use auxiliary/scanner/smb/smb_version

# EternalBlue 확인
use auxiliary/scanner/smb/smb_ms17_010

# 설정
set rhosts <target>
run
```

---

## 일반적인 Share 이름

### Windows 기본 Share

```
ADMIN$      - 원격 관리용 (C:\Windows, 관리자 전용)
C$          - C 드라이브 루트 (관리자 전용)
D$, E$      - 다른 드라이브 (관리자 전용)
IPC$        - 프로세스 간 통신 (익명 접속 가능)
print$      - 프린터 드라이버
```

### 일반 공유 폴더

```
Public      - 공용 폴더
Users       - 사용자 홈 디렉토리
Share       - 일반 공유 폴더
Backup      - 백업 파일
Documents   - 문서 폴더
```

**참고**: `$`로 끝나는 Share는 숨겨진 Share (관리용)

---

## 실전 워크플로우

### 단계별 SMB 진단

```bash
# 1. 기본 정보 수집
nmap -p 445 -sV -sC <target>

# 2. Share 열거
nxc smb <target> -u '' -p '' --shares

# 3. 접근 가능한 Share 확인
smbclient //<target>/<share> -N

# 4. 파일 다운로드
smbclient //<target>/Public -N
smb> mget *

# 5. 취약점 스캔
nmap -p 445 --script "smb-vuln-*" <target>
```

### 인증 정보 확보 후

```bash
# 1. 모든 Share 접근 테스트
nxc smb <target> -u <user> -p <pass> --shares

# 2. 원격 명령 실행 (관리자 권한)
nxc smb <target> -u <admin> -p <pass> -x "whoami"

# 3. 파일 업로드
smbclient //<target>/C$ -U <admin>
smb> put backdoor.exe
```

---

## 주요 명령어 요약

```bash
# 기본 스캔
nmap -p 445 -sV -sC <target>

# 정보 수집
enum4linux -a <target>
nxc smb <target> -u '' -p ''
smbmap -H <target> -u '' -p ''

# Share 목록
smbclient -L //<target> -N

# Share 접속
smbclient //<target>/<share> -N
smbclient //<target>/<share> -U <username>

# 취약점 스캔
nmap -p 445 --script "smb-vuln-*" <target>

# 마운트
sudo mount -t cifs //<target>/<share> /mnt/smb -o guest
```

## 보안 권장사항

1. ✅ SMBv1 비활성화
2. ✅ SMB Signing 활성화
3. ✅ Null Session 비활성화
4. ✅ Share 권한 최소화
5. ✅ 방화벽으로 외부 접근 차단
6. ✅ 정기적인 패치 적용
7. ✅ 강력한 비밀번호 정책
